// Prisma Schema for TournaNet
// This is a minimal schema to bootstrap the database connection.
// Full schema will be defined during database design phase.

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Placeholder model - will be replaced with actual schema
model HealthCheck {
    id        String   @id @default(cuid())
    checkedAt DateTime @default(now())
}

enum UserRole {
    ADMIN
    SCORER
}

model User {
    id           String   @id @default(uuid())
    email        String   @unique
    passwordHash String
    role         UserRole @default(SCORER)
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@map("users")
}

model School {
    id           String   @id @default(uuid())
    name         String   @db.VarChar(200)
    district     String   @db.VarChar(200)
    contactName  String   @db.VarChar(100)
    contactEmail String   @db.VarChar(255)
    contactPhone String?  @db.VarChar(20)
    logoUrl      String?  @db.VarChar(255)
    shortCode    String   @unique @db.VarChar(10) // For Bib generation (e.g., 'STJS')
    createdAt    DateTime @default(now())
    updatedAt    DateTime @updatedAt

    @@unique([name, district])
    @@map("schools")
    athletes Athlete[]
}

enum Gender {
    MALE
    FEMALE
}

enum AthleteCategory {
    U14
    U17
    U19
}

model Athlete {
    id           String          @id @default(uuid())
    name         String          @db.VarChar(100)
    age          Int
    gender       Gender
    category     AthleteCategory
    personalBest String?
    bibNumber    String          @unique // Format: DIST-SCHOOL-001
    schoolId     String
    school       School          @relation(fields: [schoolId], references: [id])
    createdAt    DateTime        @default(now())
    updatedAt    DateTime        @updatedAt

    @@unique([name, age, schoolId])
    @@map("athletes")
    heatLanes     HeatLane[]
    results       Result[]
    registrations EventRegistration[]
}

enum EventType {
    TRACK
    FIELD
}

model Event {
    id        String          @id @default(uuid())
    name      String          @db.VarChar(100)
    eventType EventType
    gender    Gender
    category  AthleteCategory
    date      DateTime        @db.Date
    startTime String          @db.VarChar(5) // HH:mm
    venue     String?         @db.VarChar(100)
    rules     Json            // Stores TrackRules or FieldRules
    createdAt DateTime        @default(now())
    updatedAt DateTime        @updatedAt

    @@unique([name, gender, category])
    @@map("events")
    heats         Heat[]
    registrations EventRegistration[]
}

model Heat {
    id         String     @id @default(uuid())
    eventId    String
    event      Event      @relation(fields: [eventId], references: [id])
    heatNumber Int
    lanes      HeatLane[]
    results    Result[]
    createdAt  DateTime   @default(now())
    updatedAt  DateTime   @updatedAt

    @@unique([eventId, heatNumber])
    @@map("heats")
}

model HeatLane {
    id         String   @id @default(uuid())
    heatId     String
    heat       Heat     @relation(fields: [heatId], references: [id])
    laneNumber Int
    athleteId  String
    athlete    Athlete  @relation(fields: [athleteId], references: [id])
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    @@unique([heatId, laneNumber])
    @@map("heat_lanes")
}

enum ResultStatus {
    FINISHED
    DNS
    DNF
    DQ
}

model Result {
    id          String       @id @default(uuid())
    heatId      String
    heat        Heat         @relation(fields: [heatId], references: [id])
    athleteId   String
    athlete     Athlete      @relation(fields: [athleteId], references: [id])
    bibNumber   String
    resultValue String?      // "10.5s" or "5.62m"
    status      ResultStatus
    rank        Int?
    notes       String?
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt

    @@unique([heatId, athleteId]) // One result per athlete per heat
    @@map("results")
}

model EventRegistration {
    id        String   @id @default(uuid())
    athleteId String
    athlete   Athlete  @relation(fields: [athleteId], references: [id])
    eventId   String
    event     Event    @relation(fields: [eventId], references: [id])
    createdAt DateTime @default(now())

    @@unique([athleteId, eventId])
    @@map("event_registrations")
}
